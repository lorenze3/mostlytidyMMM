<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Complete MMM Workflow In R • mostlytidyMMM</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="A Complete MMM Workflow In R">
<meta property="og:description" content="a hybrid MMM approach built on tidymodels and McElreath's
    rethinking packages.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">mostlytidyMMM</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/demonstration-of-parts-of-the-package.html">Demonstration of Parts of the Package</a>
    </li>
    <li>
      <a href="articles/hyperparameter-and-formula-search.html">Hyperparameter and Formula Search</a>
    </li>
  </ul>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div class="section level1">
<div class="page-header"><h1 id="mostlytidymmm">mostlytidyMMM<a class="anchor" aria-label="anchor" href="#mostlytidymmm"></a>
</h1></div>
<p><span style="color: red;"> <strong>This is a pre-alpha release package! Assume none of it works correctly!</strong> </span></p>
<!-- badges: start -->

<div class="section level2">
<h2 id="intent">Intent<a class="anchor" aria-label="anchor" href="#intent"></a>
</h2>
<p>mostlytidyMMM is a toolkit for building a marketing mix model.</p>
<p>Similar to Meta’s <a href="https://facebookexperimental.github.io/Robyn/" class="external-link">Robyn</a> and Google’s <a href="https://github.com/google/lightweight_mmm" class="external-link">lightweightMMM</a> in that it offers basic MMM capability without an analyst needing to choose write their own functions. In terms of philosophy of MMM, this package is somewhere between Robyn and lightweightMMM – it uses pre-modelling transformations for time delayed effects (i.e. adstocking) and saturation transformations like Robyn, but the final coefficients are estimated via MCMC in Stan to take advantage of constrained, prior informed regression models.</p>
<p><a href="https://github.com/tidymodels/tidymodels" class="external-link">tidymodels</a> provides the hyperparameter tuning and McElreath’s <a href="https://github.com/rmcelreath/rethinking" class="external-link">rethinking</a> builds a link to Stan.. To take those two foundations and build an MMM package, mostlytidyMMM has recipe steps for adstock and saturation, functions to build workflowsets out of multiple formulas, a translator from a string formula to rethinking::ulam() input, and a custom decomposition formula.</p>
<p>Unlike either of those packages, mostlytidyMMM allows for complete control on the part of the analyst to choose the level of data granularity and model form (<em>welp</em>, currently only allows normal regression, but it is a hierarchical bayesian regression and the specification of that is entirely up to the analyst).</p>
<p>In general, mostlytidyMMM allows an analyst with a table ready for MMM to specify a reasonable set of models and priors in an .xlsx configuration file and quickly hone in on a ‘final’ model specification.</p>
</div>
<div class="section level2">
<h2 id="on-the-roadmap">On the Roadmap<a class="anchor" aria-label="anchor" href="#on-the-roadmap"></a>
</h2>
<p>I think the following features are in rough priority order:</p>
<ul>
<li>visualizing response functions</li>
<li>poisson and log-normal regression</li>
<li>a budget optimizer</li>
</ul>
</div>
<div class="section level2">
<h2 id="thank-thinkr-for-fusen">Thank thinkr for FUSEN!<a class="anchor" aria-label="anchor" href="#thank-thinkr-for-fusen"></a>
</h2>
<p>This package is a package, and not a bunch of functions, thanks to thinkr’s <a href="https://thinkr-open.github.io/fusen/" class="external-link">fusen</a>. I highly recommend it.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>After installing <a href="https://mc-stan.org/cmdstanr/" class="external-link">cmdstanr</a> and <a href="https://github.com/rmcelreath/rethinking" class="external-link">rethinking</a>, mostlytidyMMM can be installed directly from <a href="https://github.com/" class="external-link">GitHub</a> via:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"lorenze3/mostlytidyMMM"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a>
</h2>
<p>Full documentation website on: <a href="https://lorenze3.github.io/mostlytidyMMM" class="external-link uri">https://lorenze3.github.io/mostlytidyMMM</a></p>
</div>
<div class="section level2">
<h2 id="straightfoward-mmm-walkthrough">Straightfoward MMM walkthrough<a class="anchor" aria-label="anchor" href="#straightfoward-mmm-walkthrough"></a>
</h2>
<p>When no tuning is required, a few function calls translate the .xlsx file into a fitted model.</p>
<p>First we read in the configuration file:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mostlytidyMMM</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rethinking</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">control_file</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'no_tuning_example.xlsx'</span>,package<span class="op">=</span><span class="st">'mostlytidyMMM'</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#get each relevant table of the control file:</span></span>
<span><span class="va">var_controls</span><span class="op">&lt;-</span><span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html" class="external-link">read_xlsx</a></span><span class="op">(</span><span class="va">control_file</span>,<span class="st">'variables'</span><span class="op">)</span></span>
<span><span class="va">transform_controls</span><span class="op">&lt;-</span><span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html" class="external-link">read_xlsx</a></span><span class="op">(</span><span class="va">control_file</span>,<span class="st">'role controls'</span><span class="op">)</span></span>
<span><span class="va">workflow_controls</span><span class="op">&lt;-</span><span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html" class="external-link">read_xlsx</a></span><span class="op">(</span><span class="va">control_file</span>,<span class="st">"workflow"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">desc</span><span class="op">)</span></span></code></pre></div>
<p>The next few lines read in the data and then use the configuration files to rename, group, and sort the file.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data1</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'example2.csv'</span>,package<span class="op">=</span><span class="st">'mostlytidyMMM'</span><span class="op">)</span><span class="op">)</span><span class="op">|&gt;</span><span class="fu"><a href="reference/rename_columns_per_controls.html">rename_columns_per_controls</a></span><span class="op">(</span>variable_controls<span class="op">=</span><span class="va">var_controls</span><span class="op">)</span><span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="reference/rename_columns_per_controls.html">rename_columns_per_controls</a></span><span class="op">(</span><span class="op">)</span><span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>week<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">week</span>,<span class="st">"%m/%d/%Y"</span><span class="op">)</span><span class="op">)</span><span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="reference/add_fourier_vars.html">add_fourier_vars</a></span><span class="op">(</span>vc<span class="op">=</span><span class="va">var_controls</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="reference/add_groups_and_sort.html">add_groups_and_sort</a></span><span class="op">(</span>vc<span class="op">=</span><span class="va">var_controls</span><span class="op">)</span> </span></code></pre></div>
<p>Now we create a recipe for the pre-processing and a model formula (in the style of lmer()) based on the data and the 3 config tables</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">no_tuning_recipe</span><span class="op">&lt;-</span><span class="fu"><a href="reference/create_recipe.html">create_recipe</a></span><span class="op">(</span><span class="va">data1</span>,vc<span class="op">=</span><span class="va">var_controls</span>,mc<span class="op">=</span><span class="va">transform_controls</span>,wc<span class="op">=</span><span class="va">workflow_controls</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Returning more (or less) than 1 row per `summarise()` group was deprecated in</span></span>
<span><span class="co">#&gt; dplyr 1.1.0.</span></span>
<span><span class="co">#&gt; i Please use `reframe()` instead.</span></span>
<span><span class="co">#&gt; i When switching from `summarise()` to `reframe()`, remember that `reframe()`</span></span>
<span><span class="co">#&gt;   always returns an ungrouped data frame and adjust accordingly.</span></span>
<span><span class="co">#&gt; i The deprecated feature was likely used in the recipes package.</span></span>
<span><span class="co">#&gt;   Please report the issue at &lt;]8;;https://github.com/tidymodels/recipes/issueshttps://github.com/tidymodels/recipes/issues]8;;&gt;.</span></span>
<span><span class="co">#&gt; This warning is displayed once every 8 hours.</span></span>
<span><span class="co">#&gt; Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span>
<span><span class="co">#&gt; generated.</span></span>
<span><span class="co">#&gt; Recipe</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Inputs:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          role #variables</span></span>
<span><span class="co">#&gt;         group          2</span></span>
<span><span class="co">#&gt;       outcome          1</span></span>
<span><span class="co">#&gt;   postprocess          3</span></span>
<span><span class="co">#&gt;     predictor         17</span></span>
<span><span class="co">#&gt;         price          1</span></span>
<span><span class="co">#&gt;  programmatic          2</span></span>
<span><span class="co">#&gt;          time         11</span></span>
<span><span class="co">#&gt;       time_id          1</span></span>
<span><span class="co">#&gt;         trend          1</span></span>
<span><span class="co">#&gt;            tv          4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Operations:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Adstock Transformation with retention 0.5 on"TV1"</span></span>
<span><span class="co">#&gt; Saturation (asymptote= 250 saturation_speed= 1e-04 Transformation on"TV1"</span></span>
<span><span class="co">#&gt; Adstock Transformation with retention 0.5 on"TV2"</span></span>
<span><span class="co">#&gt; Saturation (asymptote= 250 saturation_speed= 1e-04 Transformation on"TV2"</span></span>
<span><span class="co">#&gt; Adstock Transformation with retention 0.5 on"ProgVideo1"</span></span>
<span><span class="co">#&gt; Saturation (asymptote= 200 saturation_speed= 0.0015 Transformation on"ProgVideo1"</span></span>
<span><span class="co">#&gt; Variables selected -has_role("postprocess")</span></span>
<span><span class="co">#&gt; Novel factor level assignment for all_of(&lt;chr: "product", "store"&gt;)</span></span>
<span><span class="co">#&gt; Variable mutation for all_of(&lt;chr: "product", "store"&gt;)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">formula_in_a_string</span><span class="op">&lt;-</span><span class="fu"><a href="reference/create_formula.html">create_formula</a></span><span class="op">(</span>base_recipe<span class="op">=</span><span class="va">no_tuning_recipe</span>,control<span class="op">=</span><span class="va">workflow_controls</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "sales ~ price + TV1 + TV2 + ProgVideo1 + trend + sin1 + cos1 + (1|store) + (TV1|store)"</span></span></code></pre></div>
<p>create a rethinking::ulam appropriate flist from the formula and the config tables (priors from config, e.g.) and also a set of constraint statements:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">expressions_for_ulam</span><span class="op">&lt;-</span><span class="fu"><a href="reference/create_ulam_list.html">create_ulam_list</a></span><span class="op">(</span>prior_controls<span class="op">=</span><span class="va">var_controls</span>,model_formula<span class="op">=</span><span class="va">formula_in_a_string</span>,</span>
<span>                 grand_intercept_prior<span class="op">=</span><span class="st">'normal(45,25)'</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; sales ~ normal(big_model, big_sigma)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d2bfcd8&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; big_model &lt;- big_model_1 + a0 + store_int[store_id] + b_TV1_interact_store[store_id]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; big_model_1 &lt;- b_price * price + b_TV1 * TV1 + b_TV2 * TV2 + </span></span>
<span><span class="co">#&gt;     b_ProgVideo1 * ProgVideo1 + b_trend * trend + b_sin1 * sin1 + </span></span>
<span><span class="co">#&gt;     b_cos1 * cos1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b_TV1_interact_store</span></span>
<span><span class="co">#&gt; b_TV1_interact_store[store_id] ~ normal(0, slope_sigma)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d803440&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $store</span></span>
<span><span class="co">#&gt; store_int[store_id] ~ normal(65, int_sigma)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d7f2f68&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b_trend</span></span>
<span><span class="co">#&gt; b_trend ~ normal(0, 10)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d807d70&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b_sin1</span></span>
<span><span class="co">#&gt; b_sin1 ~ normal(0, 10)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d807d70&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b_cos1</span></span>
<span><span class="co">#&gt; b_cos1 ~ normal(0, 10)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d807d70&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b_price</span></span>
<span><span class="co">#&gt; b_price ~ normal(-20, 10)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d670630&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b_TV1</span></span>
<span><span class="co">#&gt; b_TV1 ~ normal(6, 10)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d67b788&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b_TV2</span></span>
<span><span class="co">#&gt; b_TV2 ~ normal(6, 10)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d6812e8&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b_ProgVideo1</span></span>
<span><span class="co">#&gt; b_ProgVideo1 ~ normal(2, 10)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d682ef8&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[13]]</span></span>
<span><span class="co">#&gt; a0 ~ normal(45, 25)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d2bfcd8&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[14]]</span></span>
<span><span class="co">#&gt; big_sigma ~ half_cauchy(0, 100)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d2bfcd8&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[15]]</span></span>
<span><span class="co">#&gt; int_sigma ~ half_cauchy(0, 10)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d2bfcd8&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[16]]</span></span>
<span><span class="co">#&gt; slope_sigma ~ half_cauchy(0, 10)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x000000002d2bfcd8&gt;</span></span>
<span></span>
<span></span>
<span><span class="op">(</span><span class="va">bounds_for_ulam</span><span class="op">&lt;-</span><span class="fu"><a href="reference/make_bound_statements.html">make_bound_statements</a></span><span class="op">(</span>variable_controls<span class="op">=</span><span class="va">var_controls</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $b_price</span></span>
<span><span class="co">#&gt; [1] "upper=0"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b_TV1</span></span>
<span><span class="co">#&gt; [1] "lower=0"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b_TV2</span></span>
<span><span class="co">#&gt; [1] "lower=0"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b_ProgVideo1</span></span>
<span><span class="co">#&gt; [1] "lower=0"</span></span></code></pre></div>
<p>Bake data (ie, apply the transformations) and call rethinking::ulam to fit the bayesian regression (in this case with random slopes and intercepts). <strong>NB:</strong>In actual use, much higher iteration numbers are preferred.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_data</span><span class="op">&lt;-</span><span class="va">no_tuning_recipe</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">prep</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">bake</span><span class="op">(</span><span class="va">data1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fitted_model_obj</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/ulam.html" class="external-link">ulam</a></span><span class="op">(</span><span class="va">expressions_for_ulam</span>, </span>
<span>                     <span class="va">model_data</span>,</span>
<span>                     constraints<span class="op">=</span><span class="va">bounds_for_ulam</span>,</span>
<span>                     chains<span class="op">=</span><span class="fl">2</span>,</span>
<span>                     iter<span class="op">=</span><span class="fl">100</span>,</span>
<span>                     cores<span class="op">=</span><span class="fl">2</span>,</span>
<span>                     file<span class="op">=</span><span class="st">'no_tuning_mod'</span>,<span class="co">#have a care to remove this if you want to resample!</span></span>
<span>                     declare_all_data<span class="op">=</span><span class="cn">F</span>,</span>
<span>                     messages<span class="op">=</span><span class="cn">F</span></span>
<span>                   <span class="op">)</span></span></code></pre></div>
<p>a predict method for ulam objects is included in the mostlytidyMMM package</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_data</span><span class="op">$</span><span class="va">pred</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fitted_model_obj</span>,<span class="va">model_data</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<p>Some basic charts of fit, as examples:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">this_rsq</span><span class="op">&lt;-</span><span class="fu">rsq</span><span class="op">(</span><span class="va">model_data</span><span class="op">|&gt;</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span>,truth<span class="op">=</span><span class="va">sales</span>,estimate<span class="op">=</span><span class="va">pred</span><span class="op">)</span><span class="op">[</span><span class="st">'.estimate'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">this_mape</span><span class="op">&lt;-</span><span class="fu">mape</span><span class="op">(</span><span class="va">model_data</span><span class="op">|&gt;</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span>,truth<span class="op">=</span><span class="va">sales</span>,estimate<span class="op">=</span><span class="va">pred</span><span class="op">)</span><span class="op">[</span><span class="st">'.estimate'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">model_data</span> ,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">sales</span>,y<span class="op">=</span><span class="va">pred</span>,color<span class="op">=</span><span class="va">store_id</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>slope<span class="op">=</span><span class="fl">1</span>,intercept<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">+</span><span class="fu">ggthemes</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemes/man/theme_tufte.html" class="external-link">theme_tufte</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Predicted vs Actual"</span>,subtitle<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Rsq is '</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">this_rsq</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-example%207-1.png" width="100%"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_preds_long</span><span class="op">&lt;-</span><span class="va">model_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pred</span>,<span class="va">sales</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">model_preds_long</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">week</span>,y<span class="op">=</span><span class="va">value</span>,color<span class="op">=</span><span class="va">name</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Sales and Predicted Sales by Week"</span>,subtitle<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">'MAPE is'</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">this_mape</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-example%208-1.png" width="100%"></p>
<p>a function for decomposition is included as well:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">decomps</span><span class="op">&lt;-</span><span class="fu"><a href="reference/get_decomps_irregardless.html">get_decomps_irregardless</a></span><span class="op">(</span><span class="va">model_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span>,recipe_to_use<span class="op">=</span><span class="va">no_tuning_recipe</span>,</span>
<span>                         model_obj<span class="op">=</span><span class="va">fitted_model_obj</span>,</span>
<span>                         <span class="op">)</span></span></code></pre></div>
<p>Roll those up to total by week and plot them:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">decomps_natl</span><span class="op">&lt;-</span><span class="va">decomps</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">week</span>,<span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="reference/get_predictors_vector.html">get_predictors_vector</a></span><span class="op">(</span><span class="va">no_tuning_recipe</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html" class="external-link">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>,<span class="va">sum</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">decomps_natl</span><span class="op">&lt;-</span><span class="va">decomps_natl</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">week</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">decomps_natl</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">week</span>,y<span class="op">=</span><span class="va">value</span>,fill<span class="op">=</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_area</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu">ggthemes</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggthemes/man/theme_tufte.html" class="external-link">theme_tufte</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Decomposition By Week"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-example%2010-1.png" width="100%"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing mostlytidyMMM</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Lorenzen Ted <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://app.codecov.io/gh/lorenze3/mostlytidyMMM?branch=main" class="external-link"><img src="https://codecov.io/gh/lorenze3/mostlytidyMMM/branch/main/graph/badge.svg" alt="Codecov test coverage"></a></li>
<li><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="Lifecycle: experimental"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Lorenzen Ted.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
